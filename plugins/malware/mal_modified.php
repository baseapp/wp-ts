<?php
/**
 * Meta Info
 * FILE_NAME: mal_modified.php
 * LABEL: Recently Modified Files
 * HELP : Show Recently Modified Files
 * LINK_MAIN: /malware/mal_modified
 */

if(!defined('WP_TS')) die('Invalid Access');

respond('POST','/malware/mal_modified', 'malware_mal_modified');

function malware_mal_modified(TsRequest $request, TsResponse $response)
{

    $info = getModified(realpath(TS_ABSPATH));

    $response->data->simpleData = "Recently Modfied Files";

    $showFiles = array();

    foreach($info['files'] as $fileData) {
        if(strstr($fileData['path'],"wp-ts"))continue;
        $showFiles[] = array(str_replace(TS_ABSPATH,'',$fileData['path']), $fileData['size'], $fileData['time']);
    }


    $response->data->tableColumns = array(['title'=>'File Path'],
        ['title'=>'Size'],['title'=>'Modified Time']);

    $response->data->tableFormats = array(['type'=>'text'],
        ['type'=>'size'],['type'=>'date']);


    $response->data->tableData = $showFiles;
    $response->data->tableOrder = array(array('2','desc'));

    $response->data->table = true;
    $response->sendDataJson();
}

function getModified($path)
{
    error_log($path);
    $totalsize = 0;
    $totalcount = 0;
    $dircount = 0;
    $files = array();
    if($handle = opendir($path))
    {
        while (false !== ($file = readdir($handle)))
        {
            $nextpath = $path . '/' . $file;
            if($file != '.' && $file != '..' && !is_link ($nextpath))
            {
                if(is_dir($nextpath))
                {
                    $dircount++;
                    $result = getModified($nextpath);
                    $totalsize += $result['size'];
                    $totalcount += $result['count'];
                    $dircount += $result['dircount'];
                    $files += $result['files'];
                }
                else if(is_file ($nextpath))
                {
                    $files[] = array('path'=>$nextpath,'size'=>filesize ($nextpath),'time'=>filemtime($nextpath));
                    $totalsize += filesize ($nextpath);

                    $mb = 1024*1024;

                    if(filesize ($nextpath) > 10*$mb) {
                        //echo $nextpath.' : '. ( filesize ($nextpath) / $mb ) .' MB<br />';
                    }


                    $totalcount++;
                }
            }
        }
    }
    closedir($handle);
    $total['size'] = $totalsize;
    $total['count'] = $totalcount;
    $total['dircount'] = $dircount;
    $total['files'] = $files;
    return $total;
}